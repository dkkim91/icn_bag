<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>인천공항 출도착 스케줄</title>
  <style>
    body { font-family: 'Malgun Gothic', Arial, sans-serif; margin: 0; background: #f9f9f9; }
    .container { max-width: 900px; margin: 10px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 12px #ccc; padding: 16px; }
    h2 { text-align: center; margin-bottom: 10px; color: #222; }
    .info { text-align: center; font-size: 0.95em; color: #444; margin-bottom: 8px; }
    .filters { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0 16px 0; justify-content: center; } /* 필터 중앙 정렬 추가 */
    .filters label { font-size:0.98em; margin-right:4px; }
    .filters input, .filters select { padding:4px 8px; font-size:1em; border:1px solid #ccc; border-radius: 5px; }
    .filters .btn { background:#2563eb; color:#fff; border:none; padding:4px 14px; border-radius:6px; cursor:pointer;}
    table { width:100%; border-collapse:collapse; margin-top: 6px; }
    th,td { padding:5px 3px; border-bottom:1px solid #e2e2e2; font-size:0.97em; text-align:center;}
    th { background:#f2f5fa; color:#2563eb; }
    tr:nth-child(even) { background:#fafbff; }
    #rowCount { font-weight:bold; margin:10px 0 0 2px; text-align:right;}
    #refreshBtn { margin-left:10px; background:#e1e8ff; color:#222; border:1px solid #7ca5ea; border-radius:6px; padding:3px 9px; cursor:pointer; }
    @media (max-width:700px) {
      .container { padding:5px;}
      table, thead, tbody, th, td, tr { font-size:0.93em; }
      #rowCount { text-align:center;}
      .filters { flex-direction:column; align-items:center;} /* 모바일 뷰 필터 정렬 조정 */
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>인천공항 출도착 스케줄</h2>
    <div class="info" id="info-date">
      데이터 갱신시각: <span id="updated_at"></span>
      <button id="refreshBtn" title="API에서 최신 정보 새로고침">⟳ 전체조회</button>
    </div>
    <form class="filters" id="filters">
      <label>출발일
        <select id="date">
          <option value="">전체</option>
          </select>
      </label>
      <label>KAL/OAL
        <select id="kal_oal"><option value="">전체</option><option value="KAL">KAL</option><option value="OAL">OAL</option></select>
      </label>
      <label>항공사
        <input type="text" id="airline" placeholder="예: 대한항공">
      </label>
      <label>편명
        <input type="text" id="flightId" placeholder="예: KE123">
      </label>
      <label>구간
        <input type="text" id="sector" placeholder="예: ICN/NRT">
      </label>
      <label>출도착
        <select id="op_type"><option value="">전체</option><option value="출발">출발</option><option value="도착">도착</option></select>
      </label>
      <label>시간
        <input type="text" id="ops_hour" placeholder="예: 08">
      </label>
      <label>상태
        <select id="status"><option value="">전체</option><option value="정시">정시</option><option value="지연">지연</option><option value="조기">조기</option></select>
      </label>
      <label>터미널
        <input type="text" id="terminalId" size="2">
      </label>
      <label>체크인
        <input type="text" id="chkinRange" size="5">
      </label>
      <label>게이트
        <input type="text" id="gateNumber" size="2">
      </label>
      <label>벨트
        <input type="text" id="carousel" size="2">
      </label>
      <label>출구
        <input type="text" id="exitNumber" size="2">
      </label>
      <button class="btn" type="submit">검색</button>
    </form>
    <div id="rowCount"></div>
    <div style="overflow-x:auto;">
      <table id="skd-table">
        <thead>
          <tr>
            <th>출발일</th> <th>KAL/OAL</th><th>항공사</th><th>편명</th><th>구간</th><th>출도착</th>
            <th>예정시</th><th>실제시</th><th>상태</th><th>터미널</th>
            <th>체크인</th><th>게이트</th><th>벨트</th><th>출구</th>
          </tr>
        </thead>
        <tbody id="skd-tbody">
          <tr><td colspan="14">데이터를 불러오는 중...</td></tr> </tbody>
      </table>
    </div>
  </div>
  <script>
    // === 구글시트 'skd' 데이터 공개공유로 발급된 JSON URL 입력
    const SHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbwLdDd2AtP6eEM3BDM1aN9p_Gc0J9oetcM8-VI7BEb6oBe2ufwRiACbV1u5eTWniZjQiw/exec";
    let SKD_DATA = [];

    // KST(HH:MM) 변환 함수 (ZULU TIME 또는 YYYYMMDDHHMM 문자열을 한국시간 HH:MM으로 변환)
    function formatToKST_HHmm(timeStr) {
      if (typeof timeStr !== 'string' || !timeStr) return "";

      // ZULU TIME (ISO 8601) 형식 처리 예: "2024-07-14T03:00:00Z"
      if (timeStr.includes('T') && timeStr.endsWith('Z')) {
        let d = new Date(timeStr);
        if (!isNaN(d.getTime())) {
          d.setHours(d.getHours() + 9); // UTC에 9시간 더해서 KST
          return d.toISOString().substring(11, 16); // HH:MM 추출
        }
      }
      // YYYYMMDDHHMM 형식 처리 예: "202507130540"
      if (timeStr.length === 12 && /^\d+$/.test(timeStr)) {
          return timeStr.substring(8,10) + ":" + timeStr.substring(10,12);
      }
      // 그 외 HH:MM 형식으로 들어오는 경우 대비 (변환 필요 없음)
      if (/^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;

      return ""; // 변환할 수 없는 형식
    }

    // KST(YYYY-MM-DD HH:MM:SS) 변환 함수 (갱신시각용)
    function formatToKST_HHmmss(timeStr) {
        if (typeof timeStr !== 'string' || !timeStr) return "";

        // ISO 8601 ZULU TIME 형식 처리: "2024-07-14T03:00:00Z"
        if (timeStr.includes('T') && timeStr.endsWith('Z')) {
            let d = new Date(timeStr);
            if (!isNaN(d.getTime())) {
                // UTC 시간을 KST로 변환
                d.setHours(d.getHours() + 9);
                // YYYY-MM-DD HH:MM:SS 형식으로 포맷
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                const seconds = String(d.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
        }
        // 그 외 형식은 그대로 반환 (혹은 원하는 포맷으로 추가 변환 로직 구현)
        return timeStr;
    }

    // 날짜 YYYYMMDD → "오늘/내일" 또는 원본 YYYYMMDD 반환 (테이블 표시용)
    function dateKor(dt) {
      // dt가 유효한 문자열이고 YYYYMMDD 형식(8자리)인지 확인
      if (typeof dt !== 'string' || dt.length !== 8 || !/^\d{8}$/.test(dt)) return dt || ""; 

      const now = new Date();
      // 한국 시간 기준 오늘 날짜 (시,분,초,밀리초 제거)
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      // dt를 Date 객체로 변환 (월은 0부터 시작하므로 -1)
      const dateObj = new Date(dt.substring(0,4), dt.substring(4,6)-1, dt.substring(6,8));
      
      // 날짜 차이 계산 (일 단위)
      const diff = (dateObj.getTime() - today.getTime()) / (1000 * 3600 * 24);
      
      if (diff === 0) return "오늘";
      if (diff === 1) return "내일";
      return dt; // "오늘" 또는 "내일"이 아니면 원본 YYYYMMDD 반환
    }

    // YYYYMMDD 형식으로 날짜 반환 (필터 옵션용)
    function getFormattedDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}${month}${day}`;
    }

    // YYYYMMDDHHMM 또는 ZULU Time에서 YYYYMMDD 날짜 부분만 추출
    function extractDateFromTimeStr(timeStr) {
        if (typeof timeStr !== 'string' || !timeStr) return "";
        // YYYYMMDDHHMM 형식
        if (timeStr.length === 12 && /^\d+$/.test(timeStr)) {
            return timeStr.substring(0, 8);
        }
        // ZULU Time (ISO 8601) 형식 예: "2024-07-14T03:00:00Z"
        if (timeStr.includes('T') && timeStr.endsWith('Z')) {
            let d = new Date(timeStr);
            if (!isNaN(d.getTime())) {
                d.setHours(d.getHours() + 9); // KST로 변환
                return getFormattedDate(d);
            }
        }
        return "";
    }

    // 1. 전체 API fetch 및 필터 옵션 초기화
    async function loadDataAndRender() {
      document.getElementById("skd-tbody").innerHTML = `<tr><td colspan="14">데이터를 불러오는 중...</td></tr>`;
      
      // '출발일' 필터 옵션 동적 생성
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);

      const todayFormatted = getFormattedDate(today);
      const tomorrowFormatted = getFormattedDate(tomorrow);

      const dateSelect = document.getElementById("date");
      dateSelect.innerHTML = `
        <option value="">전체</option>
        <option value="${todayFormatted}" selected>${todayFormatted}</option>
        <option value="${tomorrowFormatted}">${tomorrowFormatted}</option>
      `;

      try {
        let res = await fetch(SHEET_JSON_URL + "?" + Date.now());
        // HTTP 상태 코드 확인 (200 OK가 아니면 에러 처리)
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        SKD_DATA = await res.json();
        renderTable();
        // 가장 최신 updated_at 표시 (데이터가 있다면 첫 번째 행의 updated_at을 한국 시간으로 변환, 없으면 현재 시간)
        // SKD_DATA에 updated_at 필드가 없으므로 현재 시각 사용
        let updated = new Date().toLocaleString('ko-KR', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12:false});
        document.getElementById("updated_at").innerText = updated;
      } catch(e) {
        console.error("데이터 로드 오류:", e);
        document.getElementById("skd-tbody").innerHTML = `<tr><td colspan="14">데이터 로드 오류가 발생했습니다. (콘솔 확인)</td></tr>`;
      }
    }

    // 2. 테이블 필터+렌더링
    function renderTable() {
      let tbody = document.getElementById("skd-tbody");
      let f = {};
      // 모든 필터 요소의 값을 가져옵니다.
      ["date","kal_oal","airline","flightId","sector","op_type","ops_hour","status","terminalId","chkinRange","gateNumber","carousel","exitNumber"].forEach(id=>{
        f[id] = document.getElementById(id).value.trim();
      });

      let filtered = SKD_DATA.filter(row => {
        // '출발일' 필터링 로직: s_time에서 날짜를 추출하여 필터값(YYYYMMDD)과 비교
        const rowDate = extractDateFromTimeStr(row.s_time);
        if (f.date && rowDate !== f.date) return false;

        // s_time의 hh 추출 (KST 기준)
        let s_time_kst = formatToKST_HHmm(row.s_time);
        let s_hour = s_time_kst ? s_time_kst.split(":")[0] : "";
        if (f.ops_hour && s_hour !== f.ops_hour.padStart(2,"0")) return false;

        // 나머지 필터링 (대소문자 구분 없이 부분 일치)
        const commonFilters = ["kal_oal", "airline", "flightId", "sector", "op_type", "status", 
                               "terminalId", "chkinRange", "gateNumber", "carousel", "exitNumber"];
        for (let k of commonFilters) {
          if (f[k] && (row[k] || "").toString().toLowerCase().indexOf(f[k].toLowerCase()) === -1) return false;
        }
        
        return true; // 모든 필터를 통과하면 포함
      });

      document.getElementById("rowCount").innerText = `총 ${filtered.length}건`;
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="14">일치하는 데이터가 없습니다.</td></tr>`; // colspan 14로 변경
        return;
      }
      tbody.innerHTML = filtered.map(row=>`
        <tr>
          <td>${dateKor(extractDateFromTimeStr(row.s_time))||""}</td> <td>${row.kal_oal||""}</td>
          <td>${row.airline||""}</td>
          <td>${row.flightId||""}</td>
          <td>${row.sector||""}</td>
          <td>${row.op_type||""}</td>
          <td>${formatToKST_HHmm(row.s_time)||""}</td>
          <td>${formatToKST_HHmm(row.e_time)||""}</td>
          <td>${row.status||""}</td>
          <td>${row.terminalId||""}</td>
          <td>${row.chkinRange||""}</td>
          <td>${row.gateNumber||""}</td>
          <td>${row.carousel||""}</td>
          <td>${row.exitNumber||""}</td>
        </tr>
      `).join('');
    }

    // 전체조회(새로고침) 버튼 → API fetch + render
    document.getElementById("refreshBtn").onclick = function() {
      loadDataAndRender();
    };

    // 검색/필터: fetch 없이 캐시 데이터만 사용
    document.getElementById("filters").onsubmit = function(e) {
      e.preventDefault();
      renderTable();
    };

    // 최초 1회 전체조회 fetch
    loadDataAndRender();
  </script>
</body>
</html>